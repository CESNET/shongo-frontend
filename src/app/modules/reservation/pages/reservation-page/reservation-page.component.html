<div
  class="reservation"
  *ngIf="(resourceService.loading$ | async) === false; else loadingResources"
>
  <mat-toolbar class="reservation__toolbar">
    <!-- Toolbar left -->
    <div class="reservation__toolbar-left">
      <button
        mat-icon-button
        (click)="drawer.toggle()"
        aria-label="Toggle side drawer"
      >
        <mat-icon>menu</mat-icon>
      </button>

      <a mat-stroked-button aria-label="Go back to app" routerLink="/">
        <mat-icon>arrow_back</mat-icon>&nbsp;Back to app
      </a>

      <button
        mat-stroked-button
        aria-label="Select calendar view"
        [matMenuTriggerFor]="viewMenu"
      >
        {{ calendar.view | titlecase }}&nbsp;<mat-icon
          >arrow_drop_down</mat-icon
        >
      </button>

      <mat-menu #viewMenu="matMenu">
        <button mat-menu-item (click)="calendar.view = CalendarView.Day">
          Day
        </button>
        <button mat-menu-item (click)="calendar.view = CalendarView.Week">
          Week
        </button>
        <button mat-menu-item (click)="calendar.view = CalendarView.Month">
          Month
        </button>
      </mat-menu>

      <div class="reservation__calendar-navigation">
        <button
          mat-icon-button
          aria-label="Previous"
          mwlCalendarPreviousView
          [view]="calendar.view"
          [(viewDate)]="calendar.viewDate"
        >
          <mat-icon>navigate_before</mat-icon>
        </button>
        <button mat-button mwlCalendarToday [(viewDate)]="calendar.viewDate">
          Today
        </button>
        <button
          mat-icon-button
          aria-label="Previous"
          mwlCalendarNextView
          [view]="calendar.view"
          [(viewDate)]="calendar.viewDate"
        >
          <mat-icon>navigate_next</mat-icon>
        </button>
      </div>

      <h1 class="reservation__date-header">
        {{ calendar.viewDate | calendarDate: calendar.view + "ViewTitle" }}
      </h1>
    </div>

    <!-- Toolbar right -->
    <div class="reservation__toolbar-right">
      <app-account-menu></app-account-menu>
    </div>
  </mat-toolbar>

  <mat-drawer-container class="reservation__main" [autosize]="true">
    <mat-drawer #drawer mode="side" opened>
      <div class="sidebar">
        <section
          class="sidebar__section sidebar__section--form-field-padded"
          *ngIf="!capacityBookingMode; else capacityBookingSection"
        >
          <h2 class="sidebar__heading">Resource selection</h2>
          <app-resource-selection-form
            (resourceChange)="selectedResource = $event"
          ></app-resource-selection-form>
        </section>

        <ng-template #capacityBookingSection>
          <section class="sidebar__section">
            <ng-container
              *ngIf="parentReservationRequest; else loadingParentOrError"
            >
              <h2 class="sidebar__heading">Reserving capacity for</h2>
              <div>
                <a
                  class="mat-primary-color"
                  [routerLink]="
                    '/reservation-request/' + parentReservationRequest.id
                  "
                  >{{
                    parentReservationRequest.virtualRoomData?.roomName ??
                      parentReservationRequest.id
                  }}</a
                >
              </div>
            </ng-container>
          </section>

          <!-- Loading or error -->
          <ng-template #loadingParentOrError>
            <ng-container
              *ngTemplateOutlet="
                (loadingParentRequest$ | async) ? loadingParent : parentError
              "
            ></ng-container>
          </ng-template>

          <!-- Loading display -->
          <ng-template #loadingParent>
            <div class="loading">
              <mat-progress-spinner
                diameter="70"
                mode="indeterminate"
                color="primary"
              ></mat-progress-spinner>
              <span>Loading parent request</span>
            </div>
          </ng-template>

          <!-- Error display -->
          <ng-template #parentError>
            <ng-container
              *ngTemplateOutlet="
                parentPropertyErrorOccured()
                  ? parentPropertyError
                  : loadingParentError
              "
            >
            </ng-container>
          </ng-template>

          <ng-template #loadingParentError>
            <div class="sidebar__loading-error">
              <div class="sidebar__error-container">
                <app-alert
                  [type]="AlertType.ERROR"
                  message="Failed to load parent request"
                  [showCloseButton]="false"
                  [isActive]="true"
                ></app-alert>
              </div>
              <button
                mat-flat-button
                color="primary"
                (click)="retryLoadingParentRequest()"
              >
                Try again
              </button>
            </div>
          </ng-template>

          <ng-template #parentPropertyError>
            <div class="sidebar__loading-error">
              <div class="sidebar__error-container">
                <app-alert
                  [type]="AlertType.ERROR"
                  [isActive]="true"
                  [showCloseButton]="false"
                  [message]="parentRequestError!.message"
                ></app-alert>
              </div>
            </div>
          </ng-template>
        </ng-template>

        <section class="sidebar__section">
          <h2 class="sidebar__heading">Calendar settings</h2>
          <mat-checkbox
            color="primary"
            (change)="calendar.highlightUsersReservations = $event.checked"
            >Highlight mine</mat-checkbox
          >
        </section>

        <section
          class="sidebar__section"
          *ngIf="selectedResource && selectedSlot"
        >
          <h2 class="sidebar__heading">Reservation slot</h2>

          <div class="sidebar__slot">
            <div
              class="sidebar__slot-part"
              *ngIf="selectedSlot && selectedSlot.start"
            >
              <div><b class="sidebar__slot-part-name">Slot start:</b></div>
              <div class="sidebar__slot-part-value">
                {{ selectedSlot.start | momentDate: "LLL" }}
              </div>
            </div>

            <div
              class="sidebar__slot-part"
              *ngIf="selectedSlot && selectedSlot.end"
            >
              <div><b class="sidebar__slot-part-name">Slot end:</b></div>
              <div class="sidebar__slot-part-value">
                {{ selectedSlot.end | momentDate: "LLL" }}
              </div>
            </div>
          </div>

          <div class="sidebar__buttons">
            <button
              mat-flat-button
              color="primary"
              class="sidebar__button"
              (click)="openReservationDialog()"
            >
              Create reservation
            </button>

            <button
              mat-flat-button
              class="sidebar__button"
              color="warn"
              (click)="calendar.clearSelectedSlot()"
            >
              Cancel selection
            </button>
          </div>
        </section>
      </div>
    </mat-drawer>
    <mat-drawer-content class="reservation__content">
      <app-reservation-calendar
        #calendar
        class="reservation__calendar fullscreen-calendar"
        [allowSlotSelection]="true"
        [selectedResourceId]="selectedResource?.id"
        (slotSelected)="selectedSlot = $event"
      ></app-reservation-calendar>
    </mat-drawer-content>
  </mat-drawer-container>
</div>

<ng-template #loadingResources>
  <div class="loading loading--fullscreen">
    <h1>Loading resources</h1>
    <mat-progress-spinner
      color="primary"
      mode="indeterminate"
    ></mat-progress-spinner>
  </div>
</ng-template>
