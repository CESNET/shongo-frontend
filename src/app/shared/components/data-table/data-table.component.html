<div class="table-container" appMatTableResponsive>
  <header *ngIf="showRefreshButton || showDeleteButtons || header">
    <section class="top-header-section">
      <h4>{{ header }}</h4>

      <div class="buttons">
        <button
          *ngIf="showRefreshButton"
          mat-icon-button
          matTooltip="Refresh"
          aria-label="Refresh"
          (click)="dataSource.refreshData()"
        >
          <mat-icon>refresh</mat-icon>
        </button>

        <ng-container *ngIf="showDeleteButtons">
          <button
            mat-icon-button
            matTooltip="Delete selected"
            aria-label="Delete selected"
          >
            <mat-icon>delete</mat-icon>
          </button>
          <button
            mat-icon-button
            matTooltip="Delete all"
            aria-label="Delete all"
          >
            <mat-icon>delete_forever</mat-icon>
          </button>
        </ng-container>
      </div>
    </section>
    <mat-divider></mat-divider>
    <ng-content></ng-content>
    <mat-divider *ngIf="filter"></mat-divider>
  </header>

  <div class="mobile-table-sort">
    <h3>Table sort options</h3>

    <form class="sort-form" [formGroup]="sortForm">
      <mat-form-field appearance="outline">
        <mat-label>Field</mat-label>
        <mat-select formControlName="field">
          <mat-option
            *ngFor="let column of dataSource.displayedColumns"
            [value]="column.name"
          >
            {{ column.displayName }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Order</mat-label>
        <mat-select formControlName="order">
          <mat-option value="desc">Descending</mat-option>
          <mat-option value="asc">Ascending</mat-option>
        </mat-select>
      </mat-form-field>
    </form>
  </div>

  <table
    [hidden]="(dataSource.loading$ | async) || dataSource.data.count === 0"
    [fixedLayout]="fixedLayout"
    mat-table
    matSort
    class="full-width-table"
    aria-label="Elements"
  >
    <!-- Columns -->
    <ng-container
      *ngFor="let column of dataSource.displayedColumns"
      [matColumnDef]="column.name"
    >
      <th mat-header-cell *matHeaderCellDef mat-sort-header>
        {{ column.displayName }}
      </th>

      <!-- Default row -->
      <ng-container *ngIf="!column.component; else customColumn">
        <td
          mat-cell
          *matCellDef="let row"
          [matTooltip]="getTooltip(row[column.name])"
        >
          <ng-container *ngIf="row[column.name] as cellData; else noCellData">
            {{ cellData | appShortString: maxCellTextLength }}
          </ng-container>
          <ng-template #noCellData>
            <span style="color: gray">none</span>
          </ng-template>
        </td>
      </ng-container>

      <!-- Custom component row -->
      <ng-template #customColumn>
        <td mat-cell *matCellDef="let row">
          <div class="custom-column">
            <ng-container
              *ngComponentOutlet="
                column.component!;
                injector: createColComponentValueInjector(row[column.name])
              "
            ></ng-container>
          </div>
        </td>
      </ng-template>
    </ng-container>

    <!-- Buttons -->
    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef></th>
      <td mat-cell *matCellDef="let row">
        <div class="buttons">
          <ng-container *ngFor="let button of dataSource.buttons">
            <div [ngSwitch]="getButtonType(button)">
              <div *ngSwitchCase="TableButtonType.ACTION">
                <button
                  mat-icon-button
                  onclick="this.blur()"
                  (click)="handleButtonClick(button, row)"
                  [matTooltip]="button.name"
                  [attr.aria-label]="button.name"
                  [disabled]="
                    button.isDisabledFunc ? button.isDisabledFunc(row) : false
                  "
                >
                  <mat-icon>{{ button.icon }}</mat-icon>
                </button>
              </div>
              <div *ngSwitchCase="TableButtonType.API_ACTION">
                <button
                  mat-icon-button
                  onclick="this.blur()"
                  (click)="handleButtonClick(button, row)"
                  [matTooltip]="button.name"
                  [attr.aria-label]="button.name"
                  [disabled]="
                    button.isDisabledFunc ? button.isDisabledFunc(row) : false
                  "
                  *ngIf="
                    !(asApiActionButton(button).loading$ | async)!.includes(
                      row
                    );
                    else buttonLoading
                  "
                >
                  <mat-icon>{{ button.icon }}</mat-icon>
                </button>
                <ng-template #buttonLoading>
                  <mat-spinner
                    diameter="20"
                    strokeWidth="3"
                    color="accent"
                    class="button-loading"
                  ></mat-spinner>
                </ng-template>
              </div>
              <div *ngSwitchCase="TableButtonType.LINK">
                <a
                  *ngIf="asLinkButton(button) as linkButton"
                  mat-icon-button
                  onclick="this.blur()"
                  [routerLink]="
                    linkButton.constructPath(row, linkButton.pathTemplate)
                  "
                  [matTooltip]="button.name"
                  [attr.aria-label]="button.name"
                  [disabled]="
                    button.isDisabledFunc ? button.isDisabledFunc(row) : false
                  "
                >
                  <mat-icon>{{ button.icon }}</mat-icon>
                </a>
              </div>
            </div>
          </ng-container>
        </div>
      </td>
    </ng-container>

    <!-- Selection checkboxes -->
    <ng-container matColumnDef="select">
      <th mat-header-cell *matHeaderCellDef class="justify-center button-width">
        <mat-checkbox
          color="primary"
          (change)="$event ? masterToggle() : null"
          [checked]="selection.hasValue() && isAllSelected()"
          [indeterminate]="selection.hasValue() && !isAllSelected()"
        >
        </mat-checkbox>
      </th>
      <td mat-cell *matCellDef="let row" class="justify-center">
        <mat-checkbox
          color="primary"
          (click)="$event.stopPropagation()"
          (change)="$event ? selection.toggle(row) : null"
          [checked]="selection.isSelected(row)"
        >
        </mat-checkbox>
      </td>
    </ng-container>

    <!-- Rows -->
    <ng-container *ngIf="displayedColumns | async as columns">
      <tr mat-header-row *matHeaderRowDef="columns"></tr>
      <tr mat-row *matRowDef="let row; columns: columns"></tr>
    </ng-container>
  </table>

  <div class="loading" *ngIf="dataSource.loading$ | async">
    <mat-spinner></mat-spinner>
  </div>

  <div
    class="no-data"
    *ngIf="
      (dataSource.loading$ | async) === false && dataSource.data.count === 0
    "
  >
    <h2>No entries found</h2>
  </div>

  <mat-paginator
    #paginator
    [length]="dataSource?.data?.count"
    [pageIndex]="0"
    [pageSize]="10"
    [pageSizeOptions]="[5, 10, 20]"
    [class.extra-gap]="
      !dataSource || !dataSource.data || !dataSource.data.count
    "
    aria-label="Select page"
  >
  </mat-paginator>
</div>
