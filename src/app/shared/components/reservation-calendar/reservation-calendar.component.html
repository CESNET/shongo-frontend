<mat-card>
  <header>
    <span>{{ selectedResourceId }}</span>
    <form class="room-options" [formGroup]="filterGroup">
      <button mat-button (click)="refresh()" type="button">
        <mat-icon>refresh</mat-icon> Refresh
      </button>
      <mat-checkbox color="primary" formControlName="highlightMine"
        >Highlight your reservations</mat-checkbox
      >
      <mat-form-field *ngIf="showResourceSelection">
        <mat-label>Physical resource</mat-label>
        <mat-select formControlName="resource" (valueChange)="refresh()">
          <mat-option>
            <ngx-mat-select-search
              formControlName="resourceFilter"
              placeholderLabel="Search..."
              noEntriesFoundLabel="No resources found"
            ></ngx-mat-select-search>
          </mat-option>
          <mat-option
            *ngFor="let resource of filteredResources"
            [value]="resource.id"
          >
            {{ resource.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </form>

    <section class="calendar-options">
      <!-- Calendar view selection -->
      <div class="btn-group">
        <mat-button-toggle-group
          name="calendarView"
          aria-label="Calendar view selection"
          [value]="view"
          (valueChange)="view = $event"
        >
          <mat-button-toggle [value]="CalendarView.Day">Day</mat-button-toggle>
          <mat-button-toggle [value]="CalendarView.Week"
            >Week</mat-button-toggle
          >
          <mat-button-toggle [value]="CalendarView.Month"
            >Month</mat-button-toggle
          >
        </mat-button-toggle-group>
      </div>

      <h1>{{ viewDate | calendarDate: view + "ViewTitle" }}</h1>

      <div class="btn-group">
        <mat-button-toggle-group
          name="viewPagination"
          aria-label="Calendar pagination"
        >
          <mat-button-toggle
            value="day"
            mwlCalendarPreviousView
            [(viewDate)]="viewDate"
            [view]="view"
            ><mat-icon>chevron_left</mat-icon></mat-button-toggle
          >
          <mat-button-toggle
            value="week"
            mwlCalendarToday
            [(viewDate)]="viewDate"
            >Now</mat-button-toggle
          >
          <mat-button-toggle
            value="month"
            mwlCalendarNextView
            [(viewDate)]="viewDate"
            [view]="view"
            ><mat-icon>chevron_right</mat-icon></mat-button-toggle
          >
        </mat-button-toggle-group>
      </div>
    </section>
  </header>

  <div class="calendar-container">
    <div class="loading-overlay" *ngIf="loading$ | async" [@loading]>
      <mat-spinner id="loading-spinner"></mat-spinner>
    </div>
    <div [ngSwitch]="view">
      <mwl-calendar-day-view
        *ngSwitchCase="CalendarView.Day"
        [viewDate]="viewDate"
        [events]="events"
        [tooltipTemplate]="calendarTooltip"
        [hourSegmentTemplate]="hourSegment"
      ></mwl-calendar-day-view>
      <mwl-calendar-week-view
        *ngSwitchCase="CalendarView.Week"
        [viewDate]="viewDate"
        [events]="events"
        [tooltipTemplate]="calendarTooltip"
        [hourSegmentTemplate]="hourSegment"
        [weekStartsOn]="weekStartsOn"
      ></mwl-calendar-week-view>
      <mwl-calendar-month-view
        *ngSwitchCase="CalendarView.Month"
        [viewDate]="viewDate"
        [events]="events"
        [tooltipTemplate]="calendarTooltip"
      ></mwl-calendar-month-view>
    </div>
  </div>
</mat-card>

<ng-template
  #hourSegment
  let-segment="segment"
  let-locale="locale"
  let-segmentHeight="segmentHeight"
  let-isTimeLabel="isTimeLabel"
>
  <div
    #segmentElement
    class="cal-hour-segment"
    [style.height.px]="segmentHeight"
    [class.cal-hour-start]="segment.isStart"
    [class.cal-after-hour-start]="!segment.isStart"
    [ngClass]="segment.cssClass"
    (mousedown)="
      allowSlotSelection && startDragToCreate(segment, $event, segmentElement)
    "
  >
    <div class="cal-time" *ngIf="isTimeLabel">
      {{ segment.date | calendarDate: "weekViewHour":locale }}
    </div>
  </div>
</ng-template>

<ng-template
  #calendarTooltip
  let-contents="contents"
  let-placement="placement"
  let-event="event"
>
  <div class="cal-tooltip" [ngClass]="'cal-tooltip-' + placement">
    <div class="cal-tooltip-arrow"></div>
    <div class="cal-tooltip-inner">
      <b>Description: </b>
      <span [innerHtml]="contents"></span>
      <b>Time slot: </b>
      <span [innerHtml]="getSlotString(event)"></span>
      <b>Reserved by: </b>
      <span [innerHtml]="event.meta.owner"></span>
      <a [href]="'mailto:' + event.meta.ownerEmail">{{
        event.meta.ownerEmail
      }}</a>
    </div>
  </div>
</ng-template>
